{% extends "base.html" %}

{% block title %}Видео {{ job.job_id[:8] }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <a href="/app/jobs" class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors mb-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Назад к списку
        </a>
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-white mb-2">Задача <span class="mono text-violet-400">{{ job.job_id[:12] }}...</span></h1>
                <p class="text-slate-400">Создано: {{ job.created_at }}</p>
            </div>
            {% if job.status == 'COMPLETED' %}
            <span class="px-4 py-2 rounded-full text-sm font-semibold status-completed">Готово</span>
            {% elif job.status == 'RUNNING' %}
            <span class="px-4 py-2 rounded-full text-sm font-semibold status-running">В процессе</span>
            {% elif job.status == 'PENDING' %}
            <span class="px-4 py-2 rounded-full text-sm font-semibold status-pending">В очереди</span>
            {% elif job.status == 'FAILED' %}
            <span class="px-4 py-2 rounded-full text-sm font-semibold status-failed">Ошибка</span>
            {% endif %}
        </div>
    </div>

    <!-- Progress Bar (for non-completed jobs) -->
    {% if job.status in ['PENDING', 'RUNNING'] %}
    <div class="gradient-card p-6 rounded-2xl border border-slate-800 mb-8" id="progressCard">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">Прогресс генерации</h3>
            <span class="text-violet-400 font-mono" id="progressPercent">{{ job.progress }}%</span>
        </div>
        <div class="h-3 bg-slate-700 rounded-full overflow-hidden mb-4">
            <div id="progressBar" class="h-full bg-gradient-to-r from-violet-500 to-cyan-500 rounded-full transition-all duration-500" style="width: {{ job.progress }}%"></div>
        </div>
        <div class="flex items-center gap-3 text-slate-400">
            <div class="spinner w-5 h-5"></div>
            <span id="progressMessage">{{ job.message or 'Обработка...' }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if job.status == 'FAILED' %}
    <div class="alert-error p-6 rounded-2xl mb-8">
        <div class="flex items-start gap-4">
            <div class="w-10 h-10 bg-red-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-red-400 font-semibold mb-1">Ошибка генерации</h3>
                <p class="text-red-300/80">{{ job.error or 'Произошла неизвестная ошибка' }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Video Player -->
    {% if job.status == 'COMPLETED' and job.output_url %}
    <div class="mb-8">
        <div class="video-container">
            <video controls class="w-full" poster="">
                <source src="{{ job.output_url }}" type="video/mp4">
                Ваш браузер не поддерживает видео.
            </video>
        </div>
    </div>

    <!-- Download Buttons -->
    <div class="flex flex-wrap gap-4 mb-8">
        <a href="{{ job.output_url }}" download class="px-6 py-3 bg-gradient-to-r from-violet-600 to-violet-500 hover:from-violet-500 hover:to-violet-400 text-white font-semibold rounded-xl transition-all btn-glow flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Скачать MP4
        </a>
        {% if job.srt_url %}
        <a href="{{ job.srt_url }}" download class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Скачать SRT
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Job Details -->
    <div class="gradient-card rounded-2xl border border-slate-800 overflow-hidden">
        <div class="p-6 border-b border-slate-800">
            <h3 class="text-white font-semibold">Детали задачи</h3>
        </div>
        <div class="divide-y divide-slate-800">
            <div class="flex items-center justify-between px-6 py-4">
                <span class="text-slate-400">ID задачи</span>
                <span class="text-white mono text-sm">{{ job.job_id }}</span>
            </div>
            <div class="flex items-center justify-between px-6 py-4">
                <span class="text-slate-400">Статус</span>
                <span class="text-white">{{ job.status }}</span>
            </div>
            <div class="flex items-center justify-between px-6 py-4">
                <span class="text-slate-400">Прогресс</span>
                <span class="text-white">{{ job.progress }}%</span>
            </div>
            <div class="flex items-center justify-between px-6 py-4">
                <span class="text-slate-400">Создано</span>
                <span class="text-white">{{ job.created_at }}</span>
            </div>
            {% if job.updated_at %}
            <div class="flex items-center justify-between px-6 py-4">
                <span class="text-slate-400">Обновлено</span>
                <span class="text-white">{{ job.updated_at }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Create New Button -->
    <div class="mt-8 text-center">
        <a href="/app/create" class="inline-flex items-center gap-2 px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white font-medium rounded-xl transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Создать новое видео
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if job.status in ['PENDING', 'RUNNING'] %}
<script>
// Auto-refresh for pending/running jobs
const jobId = "{{ job.job_id }}";
let refreshInterval;

async function checkStatus() {
    try {
        const response = await fetch('/api/v1/jobs/' + jobId);
        if (!response.ok) return;

        const data = await response.json();

        // Update progress
        document.getElementById('progressPercent').textContent = data.progress + '%';
        document.getElementById('progressBar').style.width = data.progress + '%';

        if (data.message) {
            document.getElementById('progressMessage').textContent = data.message;
        }

        // If completed or failed, reload page
        if (data.status === 'COMPLETED' || data.status === 'FAILED') {
            clearInterval(refreshInterval);
            window.location.reload();
        }
    } catch (err) {
        console.error('Status check failed:', err);
    }
}

// Check every 2 seconds
refreshInterval = setInterval(checkStatus, 2000);

// Cleanup on page leave
window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
});
</script>
{% endif %}
{% endblock %}
